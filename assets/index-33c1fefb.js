var D=Object.defineProperty;var L=(s,t,i)=>t in s?D(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i;var I=(s,t,i)=>(L(s,typeof t!="symbol"?t+"":t,i),i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(n){if(n.ep)return;n.ep=!0;const r=i(n);fetch(n.href,r)}})();class b{constructor(){this.toLoad={sky:"/sprites/sky.png",ground:"/sprites/ground.png",hero:"/sprites/hero-sheet.png",shadow:"/sprites/shadow.png",rod:"/sprites/rod.png"},this.images={},Object.keys(this.toLoad).forEach(t=>{const i=new Image;i.src=this.toLoad[t],this.images[t]={image:i,isLoaded:!1},i.onload=()=>{this.images[t].isLoaded=!0}})}}const c=new b;class o{constructor(t=0,i=0){this.x=t,this.y=i}duplicate(){return new o(this.x,this.y)}}class C{constructor(){I(this,"callbacks",[]);I(this,"nextId",0)}emit(t,i){this.callbacks.forEach(e=>{e.eventName===t&&e.callback(i)})}on(t,i,e){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:t,caller:i,callback:e}),this.nextId}off(t){this.callbacks=this.callbacks.filter(i=>i.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(i=>i.caller!==t)}}const f=new C;class p{constructor({position:t}){this.position=t??new o(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1}stepEntry(t,i){this.children.forEach(e=>e.stepEntry(t,i)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(t,i)}ready(){}step(t){}draw(t,i,e){const n=i+this.position.x,r=e+this.position.y;this.drawImage(t,n,r),this.children.forEach(a=>a.draw(t,n,r))}drawImage(t,i,e){}destroy(){this.children.forEach(t=>{t.destroy()}),this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){f.unsubscribe(t),this.children=this.children.filter(i=>t!==i)}}class u extends p{constructor({resource:t,frameSize:i,hFrames:e,vFrames:n,frame:r,scale:a,position:w,animations:g}){super({name}),this.resource=t,this.frameSize=i??new o(16,16),this.hFrames=e??1,this.vFrames=n??1,this.frame=r??0,this.frameMap=new Map,this.scale=a??1,this.position=w??new o(0,0),this.animations=g??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let i=0;i<this.vFrames;i++)for(let e=0;e<this.hFrames;e++)this.frameMap.set(t,new o(this.frameSize.x*e,this.frameSize.y*i)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,i,e){if(!this.resource.isLoaded)return;let n=0,r=0;const a=this.frameMap.get(this.frame);a&&(n=a.x,r=a.y);const w=this.frameSize.x,g=this.frameSize.y;t.drawImage(this.resource.image,n,r,w,g,i,e,w*this.scale,g*this.scale)}}class E{constructor(t,i){I(this,"mainLoop",t=>{if(!this.isRunning)return;let i=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=i;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=i,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}const P="LEFT",T="RIGHT",S="UP",y="DOWN";class O{constructor(){this.heldDirections=[],document.addEventListener("keydown",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(S),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(y),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(P),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(T)}),document.addEventListener("keyup",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(S),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(y),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(P),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(T)})}get direction(){return this.heldDirections[0]}onArrowPressed(t){this.heldDirections.indexOf(t)===-1&&this.heldDirections.unshift(t)}onArrowReleased(t){const i=this.heldDirections.indexOf(t);i!==-1&&this.heldDirections.splice(i,1)}}const v=s=>s*16,K=(s,t,i)=>{const e=`${t},${i}`;return!s.has(e)},h=new Set;h.add("64,48");h.add("64,64");h.add("64,80");h.add("80,64");h.add("80,80");h.add("112,80");h.add("128,80");h.add("144,80");h.add("160,80");class H{constructor(t){this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(t,i=0){this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=i)}step(t){this.patterns[this.activeKey].step(t)}}class d{constructor(t){this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}get frame(){const{frames:t}=this.animationConfig;for(let i=t.length-1;i>=0;i--)if(this.currentTime>=t[i].time)return t[i].frame;throw"Time is before the first keyframe"}step(t){this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)}}const x=(s=0)=>({duration:400,frames:[{time:0,frame:s}]}),k=(s=0)=>({duration:400,frames:[{time:0,frame:s+1},{time:100,frame:s},{time:200,frame:s+1},{time:300,frame:s+2}]}),_=x(1),F=x(4),W=x(7),U=x(10),M=k(0),N=k(3),z=k(6),X=k(9),Y={duration:400,frames:[{time:0,frame:12}]};function q(s,t,i){let e=t.x-s.position.x,n=t.y-s.position.y,r=Math.sqrt(e**2+n**2);if(r<=i)s.position.x=t.x,s.position.y=t.y;else{let a=e/r,w=n/r;s.position.x+=a*i,s.position.y+=w*i,e=t.x-s.position.x,n=t.y-s.position.y,r=Math.sqrt(e**2+n**2)}return r}class G extends p{constructor(t,i){super({position:new o(t,i)});const e=new u({resource:c.images.shadow,frameSize:new o(32,32),position:new o(-8,-19)});this.addChild(e),this.body=new u({resource:c.images.hero,frameSize:new o(32,32),hFrames:3,vFrames:8,frame:1,position:new o(-8,-20),animations:new H({walkDown:new d(M),walkUp:new d(z),walkLeft:new d(X),walkRight:new d(N),standDown:new d(_),standUp:new d(W),standLeft:new d(U),standRight:new d(F),pickUpDown:new d(Y)})}),this.addChild(this.body),this.facingDirection=y,this.destinationPosition=this.position.duplicate(),this.itemPickupTime=0,this.itemPickupShell=null,f.on("HERO_PICKS_UP_ITEM",this,n=>{this.onPickUpItem(n)})}step(t,i){if(this.itemPickupTime>0){this.workOnItemPickup(t);return}q(this,this.destinationPosition,1)<=1&&this.tryMove(i),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,f.emit("HERO_POSITION",this.position))}tryMove(t){const{input:i}=t;if(!i.direction){this.facingDirection===P&&this.body.animations.play("standLeft"),this.facingDirection===T&&this.body.animations.play("standRight"),this.facingDirection===S&&this.body.animations.play("standUp"),this.facingDirection===y&&this.body.animations.play("standDown");return}let e=this.destinationPosition.x,n=this.destinationPosition.y;const r=16;i.direction===y&&(n+=r,this.body.animations.play("walkDown")),i.direction===S&&(n-=r,this.body.animations.play("walkUp")),i.direction===P&&(e-=r,this.body.animations.play("walkLeft")),i.direction===T&&(e+=r,this.body.animations.play("walkRight")),this.facingDirection=i.direction??this.facingDirection,K(h,e,n)&&(this.destinationPosition.x=e,this.destinationPosition.y=n)}onPickUpItem({image:t,position:i}){this.destinationPosition=i.duplicate(),this.itemPickupTime=500,this.itemPickupShell=new p({}),this.itemPickupShell.addChild(new u({resource:t,position:new o(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(t){this.itemPickupTime-=t,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}}class B extends p{constructor(){super({}),f.on("HERO_POSITION",this,t=>{this.position=new o(-t.x+152,-t.y+82)})}}class $ extends p{constructor(t,i){super({name:"Rod",position:new o(t,i)});const e=new u({resource:c.images.rod,position:new o(0,-5)});this.addChild(e)}ready(){f.on("HERO_POSITION",this,t=>{const i=Math.round(t.x),e=Math.round(t.y);i===this.position.x&&e===this.position.y&&this.onCollideWithHero()})}onCollideWithHero(){this.destroy(),f.emit("HERO_PICKS_UP_ITEM",{type:"ROD",image:c.images.rod,position:this.position})}}class j extends p{constructor(){super({position:new o(0,1)}),this.nextId=0,this.items=[{id:-1,image:c.images.rod},{id:-2,image:c.images.rod}],f.on("HERO_PICKS_UP_ITEM",this,t=>{this.nextId+=1,this.items.push({id:this.nextId,image:c.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,i)=>{const e=new u({resource:t.image,position:new o(i*12,0)});this.addChild(e)})}removeFromInventory(t){this.items=this.items.filter(i=>i.id!==t),this.renderInventory()}}const A=document.querySelector("#game-canvas"),m=A.getContext("2d"),l=new p({position:new o(0,0)}),J=new u({resource:c.images.sky,frameSize:new o(320,180)}),Q=new u({resource:c.images.ground,frameSize:new o(320,180)});l.addChild(Q);const V=new G(v(6),v(5));l.addChild(V);const R=new B;l.addChild(R);const Z=new $(v(7),v(6));l.addChild(Z);const tt=new j;l.input=new O;const it=s=>{l.stepEntry(s,l)},et=()=>{m.clearRect(0,0,A.width,A.height),J.drawImage(m,0,0),m.save(),m.translate(R.position.x,R.position.y),l.draw(m,0,0),m.restore(),tt.draw(m,0,0)},st=new E(it,et);st.start();
